<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: boardDetail.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: boardDetail.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @ts-check
/* global firebase */
/// &lt;reference path="./boardTypesD.ts" />

/**
 * Board.Detail – orchestriert den Task-Detail-Dialog (View + Edit).
 * Abhängigkeiten: Board.DetailUtil (U), Board.Assigned (Assigned)
 */
(function (w) {
  /** @type {any} */ const Win = w;
  Win.Board = Win.Board || {};
  /** @type {any} */ const Assigned = Win.Board.Assigned;
  /** @type {any} */ const U = Win.Board.DetailUtil;

  /** @typedef {"urgent"|"medium"|"low"} TaskPriority */
  /** @typedef {{title:string,done:boolean}} Subtask */
  /** @typedef {{ id:string, title?:string, description?:string, category?:string, dueDate?:string, priority?:TaskPriority, status:string, assignedTo?:string[]|string, subtasks?:Subtask[] }} Task */

  // ────────────────────────────────────────────────────────── View builders
  /** @param {Task} t */ function buildViewHTML(t) {
    const pr = { urgent: 'prio_top.svg', medium: 'prio_mid.svg', low: 'prio_low.svg' };
    const prIcon = pr[t.priority || 'medium'];
    const prLabel = (t.priority || 'medium').replace(/^\w/, c => c.toUpperCase());
    const catCls = U.getDetailCategoryClass(t.category);
    const ass = (Array.isArray(t.assignedTo) ? t.assignedTo : [t.assignedTo]).filter(Boolean)
      .map(uid => `&lt;div class="assigned-user">${Assigned?.getProfileBadge?.(String(uid))||''}&lt;span class="assigned-user-name">${Assigned?.getPersonData?.(String(uid))?.name||''}&lt;/span>&lt;/div>`).join('');
    const subs = Array.isArray(t.subtasks) &amp;&amp; t.subtasks.length
      ? t.subtasks.map((st,i)=>`&lt;label style="display:flex;align-items:center;gap:9px;">&lt;input type="checkbox" class="subtask-checkbox" data-subidx="${i}" ${st.done?'checked':''}>&lt;span>${st.title}&lt;/span>&lt;/label>`).join('')
      : '&lt;i>No subtasks.&lt;/i>';
    return `
      &lt;button id="closeTaskDetail" class="close-task-detail" aria-label="Close">&amp;times;&lt;/button>
      &lt;span class="${catCls}">${t.category||''}&lt;/span>
      &lt;h2 class="task-detail-title">${t.title||''}&lt;/h2>
      &lt;div class="task-detail-description">${t.description||''}&lt;/div>
      &lt;div class="task-detail-row">&lt;span class="task-detail-label">Due date:&lt;/span>&lt;span>${U.formatDueDate(t.dueDate||'')}&lt;/span>&lt;/div>
      &lt;div class="task-detail-row">&lt;span class="task-detail-label">Priority:&lt;/span>&lt;span style="display:flex;align-items:center;gap:8px;">&lt;span>${prLabel}&lt;/span>&lt;img src="../assets/icons/board/prio/${prIcon}" style="height:10px" alt="">&lt;/span>&lt;/div>
      &lt;div class="task-detail-row">&lt;span class="task-detail-label">Assigned To:&lt;/span>&lt;/div>
      &lt;div class="task-detail-contacts">${ass}&lt;/div>
      &lt;div class="task-detail-row" style="margin-bottom:5px;">&lt;span class="task-detail-label">Subtasks&lt;/span>&lt;/div>
      &lt;div class="task-detail-subtasks">${subs}&lt;/div>
      &lt;div class="task-detail-actions">&lt;button id="deleteTaskBtn" class="delete-btn">&lt;img src="../assets/icons/board/delete.png" alt=""> Delete&lt;/button>&lt;button id="editTaskBtn" class="edit-btn">&lt;img src="../assets/icons/board/edit.png" alt=""> Edit&lt;/button>&lt;/div>`;
  }

  /** @param {Task} t */ function buildEditHTML(t) {
    const catCls = U.getDetailCategoryClass(t.category);
    const def = (p) => (t.priority || 'medium') === p ? ' active' : '';
    return `
      &lt;button id="closeTaskDetail" class="close-task-detail" aria-label="Close">&amp;times;&lt;/button>
      &lt;span class="${catCls}">${t.category||''}&lt;/span>
      &lt;form id="editTaskForm" style="display:flex;flex-direction:column;gap:14px;">
        &lt;div class="form-group">&lt;label for="editTitle">Title&lt;/label>&lt;input id="editTitle" type="text" value="${t.title||''}">&lt;/div>
        &lt;div class="form-group">&lt;label for="editDescription">Description&lt;/label>&lt;textarea id="editDescription">${t.description||''}&lt;/textarea>&lt;/div>
        &lt;div class="form-group">&lt;label for="editDueDate">Due date&lt;/label>&lt;div class="input-icon-date">&lt;input type="date" id="editDueDate" value="${t.dueDate||''}">&lt;/div>&lt;/div>
        &lt;div class="form-group">&lt;label>Priority&lt;/label>
          &lt;div class="priority-buttons">
            &lt;button type="button" class="btn${def('urgent')}"  data-priority="urgent">Urgent &lt;img src="../assets/icons/add_task/urgent_small.png" alt="">&lt;/button>
            &lt;button type="button" class="btn${def('medium')}" data-priority="medium">Medium &lt;img src="../assets/icons/add_task/medium_orange.png" alt="">&lt;/button>
            &lt;button type="button" class="btn${def('low')}"    data-priority="low">Low &lt;img src="../assets/icons/add_task/low.png" alt="">&lt;/button>
          &lt;/div>
        &lt;/div>
        &lt;div class="form-group">&lt;label>Assigned to&lt;/label>
          &lt;div class="assigned-to-wrapper">
            &lt;div class="assigned-select-box" id="editAssignedSelectBox">&lt;span>Select contacts to assign&lt;/span>&lt;img class="imgDropdown" src="../assets/icons/add_task/arrow_drop_down.png" alt="">&lt;/div>
            &lt;div class="assigned-dropdown hidden" id="editAssignedDropdown">&lt;/div>
            &lt;div class="assigned-badges" id="editAssignedBadges">&lt;/div>
          &lt;/div>
        &lt;/div>
        &lt;div class="form-group">&lt;label for="edit-detail-subtasks">Subtasks&lt;/label>&lt;div id="edit-detail-subtasks">&lt;/div>&lt;/div>
        &lt;div style="display:flex;justify-content:flex-end;gap:14px;">&lt;button id="saveTaskBtn" class="create_task_btn" type="submit">Ok &amp;#10003;&lt;/button>&lt;/div>
      &lt;/form>`;
  }

  // ────────────────────────────────────────────────────────── Small wiring
  /** @param {HTMLDivElement} body @param {Task} task */ function wireView(body, task, dlg, toEdit) {
    body.querySelectorAll('.subtask-checkbox').forEach((el) => {
      el.addEventListener('change', (ev) => {
        const i = Number((/** @type {HTMLInputElement} */(ev.currentTarget)).dataset.subidx||'0');
        if (Array.isArray(task.subtasks) &amp;&amp; task.subtasks[i]) {
          task.subtasks[i].done = (/** @type {HTMLInputElement} */(ev.currentTarget)).checked;
          firebase.database().ref('tasks/'+task.id+'/subtasks').set(task.subtasks);
        }
      });
    });
    (/** @type {HTMLButtonElement} */(body.querySelector('#editTaskBtn'))).onclick = toEdit;
    (/** @type {HTMLButtonElement} */(body.querySelector('#deleteTaskBtn'))).onclick = () => U.showDeleteConfirmDialog(task.id, dlg);
    (/** @type {HTMLButtonElement} */(body.querySelector('#closeTaskDetail'))).onclick = () => dlg.close();
  }

  /** @param {HTMLDivElement} body */ function setMinDate(body) {
    const el = /** @type {HTMLInputElement|null} */ (body.querySelector('#editDueDate'));
    if (!el) return;
    const off = new Date().getTimezoneOffset() * 60000;
    el.min = new Date(Date.now()-off).toISOString().slice(0,10);
    el.addEventListener('input', () => { if (el.value &amp;&amp; el.value &lt; el.min) el.value = el.min; });
  }

  /** @param {HTMLDivElement} body @returns {TaskPriority} */ function wirePrioButtons(body, current) {
    /** @type {TaskPriority} */ let prio = /** @type {TaskPriority} */ (current || 'medium');
    body.querySelectorAll('.priority-buttons .btn').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        body.querySelectorAll('.priority-buttons .btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active'); prio = /** @type {TaskPriority} */ ((/** @type {HTMLElement} */(this)).dataset.priority || 'medium');
      });
    });
    return prio;
  }

  /** @param {Task} task */ function buildLocalAssign(task) {
    const allU = /** @type {Record&lt;string,{name?:string;email?:string}>} */(Win.allUsers||{});
    const allC = /** @type {Record&lt;string,{name?:string;email?:string}>} */(Win.allContacts||{});
    const pre = Array.isArray(task.assignedTo) ? task.assignedTo.map(String) : (task.assignedTo?[String(task.assignedTo)]:[]);
    const toIni = (n)=>n.split(' ').slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('');
    /** @type {Record&lt;string,{name:string;email?:string;initials:string;selected:boolean}>} */ const local = {};
    Object.entries(allU).forEach(([id,u])=>{const name=u?.name||u?.email||id; local[id]={name,email:u?.email||'',initials:toIni(name),selected:pre.includes(id)};});
    Object.entries(allC).forEach(([id,c])=>{ if(local[id])return; const name=c?.name||id; local[id]={name,initials:toIni(name),selected:pre.includes(id)};});
    return local;
  }

  /** Renders badges (max 4 + “+N”). */ function renderAssignBadges(local, bad) {
    bad.innerHTML = '';
    const sel = Object.values(local).filter(u=>u.selected);
    sel.slice(0,4).forEach(u=>{ const b=document.createElement('div'); b.className='avatar-badge'; b.textContent=u.initials; b.style.backgroundColor=Assigned?.generateColorFromString?.(u.name)||'#888'; bad.appendChild(b); });
    const extra = sel.length-4; if (extra>0){ const m=document.createElement('div'); m.className='avatar-badge avatar-badge-more'; m.textContent=`+${extra}`; bad.appendChild(m); }
  }

  /** Dropdown list with toggle &amp; scroll keep. */ function renderAssignDropdown(local, dd) {
    const keep = dd.scrollTop; dd.innerHTML = '';
    Object.entries(local).sort(([,a],[,b])=>a.name.localeCompare(b.name)).forEach(([id,u])=>{
      const opt=document.createElement('div'); opt.className='custom-option'+(u.selected?' selected':''); opt.tabIndex=0;
      const av=document.createElement('div'); av.className='custom-option-avatar'; av.style.backgroundColor=Assigned?.generateColorFromString?.(u.name)||'#888'; av.textContent=u.initials;
      const lab=document.createElement('div'); lab.className='custom-option-label'; lab.textContent=u.name+(((u.email||'').toLowerCase()===(localStorage.getItem('currentUserEmail')||'').toLowerCase())?' (You)':'');
      const chk=document.createElement('div'); chk.className='custom-option-checkbox'; if(u.selected) chk.classList.add('checked');
      const toggle=(ev)=>{ev.preventDefault();ev.stopPropagation();u.selected=!u.selected; renderAssignDropdown(local,dd); renderAssignBadges(local, /** @type {HTMLDivElement} */(document.getElementById('editAssignedBadges'))); dd.scrollTop=keep;};
      opt.addEventListener('pointerdown',toggle); opt.addEventListener('keydown',(e)=>{ if(e.key===' '||e.key==='Enter') toggle(e); });
      opt.append(av,lab,chk); dd.appendChild(opt);
    });
    dd.scrollTop = keep;
  }

  /** @param {HTMLDivElement} body @param {Record&lt;string, any>} local */ function wireAssign(body, local) {
    const sel = /** @type {HTMLDivElement} */ (body.querySelector('#editAssignedSelectBox'));
    const dd  = /** @type {HTMLDivElement} */ (body.querySelector('#editAssignedDropdown'));
    const bad = /** @type {HTMLDivElement} */ (body.querySelector('#editAssignedBadges'));
    sel.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();dd.classList.toggle('hidden');});
    document.addEventListener('click',(e)=>{ if(!(e.target instanceof Node))return; if(!sel.parentElement?.contains(e.target)) dd.classList.add('hidden'); });
    renderAssignDropdown(local, dd); renderAssignBadges(local, bad);
  }

  /** Save handler for edit form. */
  function wireSave(body, task, local, done, getPrio) {
    (/** @type {HTMLFormElement} */(body.querySelector('#editTaskForm'))).onsubmit = (e) => {
      e.preventDefault();
      const title=(/** @type {HTMLInputElement} */(body.querySelector('#editTitle'))).value.trim();
      const desc =(/** @type {HTMLTextAreaElement} */(body.querySelector('#editDescription'))).value.trim();
      const due  =(/** @type {HTMLInputElement} */(body.querySelector('#editDueDate'))).value.trim();
      const assigned=Object.entries(local).filter(([,u])=>u.selected).map(([id])=>id);
      const subs=(task.subtasks||[]).filter(st=>st&amp;&amp;st.title&amp;&amp;st.title.trim()).map(st=>({title:st.title.trim(),done:!!st.done}));
      firebase.database().ref('tasks/'+task.id).update({ title, description:desc, dueDate:due, priority:getPrio(), assignedTo:assigned, subtasks:subs }).then(done);
    };
  }

  // ────────────────────────────────────────────────────────── Entry point
  /**
   * Öffnet den Task-Detail-Dialog (View + Edit).
   * @param {Task} task
   */
  function openTaskDetail(task) {
    const dlg = /** @type {HTMLDialogElement} */ (document.getElementById('taskDetailDialog'));
    const body = /** @type {HTMLDivElement} */ (document.getElementById('taskDetailBody'));
    let isEditing = false; /** @type {TaskPriority} */ let editPrio = /** @type {TaskPriority} */(task.priority||'medium');

    const renderView = () => { body.innerHTML = buildViewHTML(task); wireView(body, task, dlg, () => { isEditing = true; render(); }); };
    const renderEdit = () => {
      body.innerHTML = buildEditHTML(task);
      setMinDate(body);
      editPrio = wirePrioButtons(body, editPrio);
      const local = buildLocalAssign(task);
      wireAssign(body, local);
      U.renderSubtasksEdit(/** @type {HTMLDivElement} */(body.querySelector('#edit-detail-subtasks')), task);
      (/** @type {HTMLButtonElement} */(body.querySelector('#closeTaskDetail'))).onclick = () => dlg.close();
      wireSave(body, task, local, () => { isEditing = false; render(); }, () => editPrio);
    };
    const render = () => (isEditing ? renderEdit() : renderView());
    render(); dlg.showModal();
  }

  // Export
  Win.Board.Detail = { openTaskDetail };
})(window);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addContactLocally">addContactLocally</a></li><li><a href="global.html#addContacts">addContacts</a></li><li><a href="global.html#addNewContact">addNewContact</a></li><li><a href="global.html#addUsers">addUsers</a></li><li><a href="global.html#allInputsValid">allInputsValid</a></li><li><a href="global.html#animateContactDetails">animateContactDetails</a></li><li><a href="global.html#animateOverlayOut">animateOverlayOut</a></li><li><a href="global.html#checkLoadingScreen">checkLoadingScreen</a></li><li><a href="global.html#clearAddContactInputs">clearAddContactInputs</a></li><li><a href="global.html#clearTaskAssignment">clearTaskAssignment</a></li><li><a href="global.html#closeContactOptions">closeContactOptions</a></li><li><a href="global.html#closeOverlay">closeOverlay</a></li><li><a href="global.html#collectUpdatedFormData">collectUpdatedFormData</a></li><li><a href="global.html#confirmLockIcon">confirmLockIcon</a></li><li><a href="global.html#createContactGroup">createContactGroup</a></li><li><a href="global.html#createDivider">createDivider</a></li><li><a href="global.html#createInitialIcon">createInitialIcon</a></li><li><a href="global.html#createSuccessOverlay">createSuccessOverlay</a></li><li><a href="global.html#deleteContact">deleteContact</a></li><li><a href="global.html#deleteContactFromEdit">deleteContactFromEdit</a></li><li><a href="global.html#deleteContactFromEditMobile">deleteContactFromEditMobile</a></li><li><a href="global.html#deleteContactFromFirebase">deleteContactFromFirebase</a></li><li><a href="global.html#deleteData">deleteData</a></li><li><a href="global.html#deleteMobileContact">deleteMobileContact</a></li><li><a href="global.html#doPasswordsMatch">doPasswordsMatch</a></li><li><a href="global.html#editContact">editContact</a></li><li><a href="global.html#editMobileContact">editMobileContact</a></li><li><a href="global.html#editOverlayDesktop">editOverlayDesktop</a></li><li><a href="global.html#editOverlayLogic">editOverlayLogic</a></li><li><a href="global.html#editOverlayMobile">editOverlayMobile</a></li><li><a href="global.html#editValidationInitialized">editValidationInitialized</a></li><li><a href="global.html#ensureOwnContactInList">ensureOwnContactInList</a></li><li><a href="global.html#errorMsgs">errorMsgs</a></li><li><a href="global.html#fillEditForm">fillEditForm</a></li><li><a href="global.html#finalizeContactDeletion">finalizeContactDeletion</a></li><li><a href="global.html#focusOnNewContact">focusOnNewContact</a></li><li><a href="global.html#getColorFromName">getColorFromName</a></li><li><a href="global.html#getContactById">getContactById</a></li><li><a href="global.html#getContactDetailsTemplate">getContactDetailsTemplate</a></li><li><a href="global.html#getContactTemplateByData">getContactTemplateByData</a></li><li><a href="global.html#getErrorMessages">getErrorMessages</a></li><li><a href="global.html#getFormData">getFormData</a></li><li><a href="global.html#getInitials">getInitials</a></li><li><a href="global.html#getRegexes">getRegexes</a></li><li><a href="global.html#goBack">goBack</a></li><li><a href="global.html#groupContactsByInitial">groupContactsByInitial</a></li><li><a href="global.html#handleContactClick">handleContactClick</a></li><li><a href="global.html#hideContactDetails">hideContactDetails</a></li><li><a href="global.html#highlightAndScrollTo">highlightAndScrollTo</a></li><li><a href="global.html#isEmailValid">isEmailValid</a></li><li><a href="global.html#isOwnContact">isOwnContact</a></li><li><a href="global.html#isPasswordValid">isPasswordValid</a></li><li><a href="global.html#loadAllTasksFromFirebase">loadAllTasksFromFirebase</a></li><li><a href="global.html#loadData">loadData</a></li><li><a href="global.html#logOutUser">logOutUser</a></li><li><a href="global.html#nameValidation">nameValidation</a></li><li><a href="global.html#onloadFunction">onloadFunction</a></li><li><a href="global.html#openContactOptions">openContactOptions</a></li><li><a href="global.html#openContactOverview">openContactOverview</a></li><li><a href="global.html#openOverlay">openOverlay</a></li><li><a href="global.html#outsideOverlayClick">outsideOverlayClick</a></li><li><a href="global.html#passwordLockIcon">passwordLockIcon</a></li><li><a href="global.html#passwordVisibility">passwordVisibility</a></li><li><a href="global.html#postData">postData</a></li><li><a href="global.html#prepareContactSwitch">prepareContactSwitch</a></li><li><a href="global.html#putData">putData</a></li><li><a href="global.html#regexes">regexes</a></li><li><a href="global.html#removeContactFromLocalArray">removeContactFromLocalArray</a></li><li><a href="global.html#removeIdFromTaskArray">removeIdFromTaskArray</a></li><li><a href="global.html#renderAllContacts">renderAllContacts</a></li><li><a href="global.html#renderContactDetails">renderContactDetails</a></li><li><a href="global.html#rerenderContactList">rerenderContactList</a></li><li><a href="global.html#resetContactOverview">resetContactOverview</a></li><li><a href="global.html#saveAsUser">saveAsUser</a></li><li><a href="global.html#saveContactToFirebase">saveContactToFirebase</a></li><li><a href="global.html#setCurrentUser">setCurrentUser</a></li><li><a href="global.html#setupEditValidation">setupEditValidation</a></li><li><a href="global.html#setupFormSubmit">setupFormSubmit</a></li><li><a href="global.html#setupInputListeners">setupInputListeners</a></li><li><a href="global.html#setupInputSanitizers">setupInputSanitizers</a></li><li><a href="global.html#setupSanitizers">setupSanitizers</a></li><li><a href="global.html#setupValidation">setupValidation</a></li><li><a href="global.html#setupValidationListeners">setupValidationListeners</a></li><li><a href="global.html#showDetails">showDetails</a></li><li><a href="global.html#showLoadingScreen">showLoadingScreen</a></li><li><a href="global.html#showOverlay">showOverlay</a></li><li><a href="global.html#showSuccessOverlay">showSuccessOverlay</a></li><li><a href="global.html#signUpUser">signUpUser</a></li><li><a href="global.html#submitSignUpForm">submitSignUpForm</a></li><li><a href="global.html#toggleSubmit">toggleSubmit</a></li><li><a href="global.html#toggleSubmitState">toggleSubmitState</a></li><li><a href="global.html#updateContactInFirebase">updateContactInFirebase</a></li><li><a href="global.html#updateFormStyles">updateFormStyles</a></li><li><a href="global.html#updateLocalContact">updateLocalContact</a></li><li><a href="global.html#updateTaskAssignedTo">updateTaskAssignedTo</a></li><li><a href="global.html#updateTasksAssignedToContact">updateTasksAssignedToContact</a></li><li><a href="global.html#userLogIn">userLogIn</a></li><li><a href="global.html#validateEmailInput">validateEmailInput</a></li><li><a href="global.html#validateForm">validateForm</a></li><li><a href="global.html#validateInput">validateInput</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validateSpecificInput">validateSpecificInput</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun Oct 05 2025 17:59:52 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
